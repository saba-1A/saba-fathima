<!-- Load Fonts -->
<style>
  @import url('https://fonts.googleapis.com/css2?family=Jost:wght@300;400;500&family=Lustria&display=swap');
</style>

<div id="ProductModal" class="custom-modal-overlay">
  <!-- Frame 1000009749 -->
  <div class="custom-modal-box">
    <!-- Close Button -->
    <button class="custom-modal-close">
      <svg width="12" height="12" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
         <path d="M1 1L13 13M1 13L13 1" stroke="black" stroke-width="1.5" stroke-linecap="round"/>
      </svg>
    </button>

    <div class="custom-modal-body">
      <!-- Top Section: Image + Info -->
      <div class="custom-modal-top">
        <!-- Image 846 -->
        <div class="custom-modal-img-container">
          <img id="ModalImg" src="" alt="Product Image">
        </div>
        
        <div class="custom-modal-info">
          <!-- Text: Product Title -->
          <h3 id="ModalTitle">Product Title</h3>
          <!-- Text: Price -->
          <p id="ModalPrice">0,00€</p>
          <!-- Text: Description -->
          <div id="ModalDesc" class="custom-modal-desc">
            Description goes here...
          </div>
        </div>
      </div>
      
      <!-- Variants Section -->
      <div class="custom-modal-variants">
        
        <!-- Color Selector (Component 211) -->
        <div class="variant-group" id="ColorGroup" style="display:none;">
          <label class="variant-label">Color</label>
          <div id="ColorContainer" class="custom-color-box">
            <!-- Colors injected via JS -->
          </div>
        </div>
        
        <!-- Size Selector (Component 213) -->
        <div class="variant-group" id="SizeGroup" style="display:none;">
          <label class="variant-label">Size</label>
          
          <div class="custom-dropdown-container" id="CustomSizeDropdown">
            <!-- Trigger Box (Rectangle 17) -->
            <div class="custom-dropdown-trigger" id="SizeTrigger">
              <span id="SelectedSizeText">Choose your size</span>
              
              <!-- Vertical Line -->
              <div class="trigger-divider"></div>
              
              <!-- Arrow Icon -->
              <div class="trigger-arrow-box">
                <svg width="10" height="6" viewBox="0 0 12 7" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M1 1L6 6L11 1" stroke="black" stroke-width="0.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </div>
            </div>

            <!-- The Hidden List (Options) -->
            <div class="custom-dropdown-options" id="SizeOptionsList">
              <!-- Options will be injected here by JS -->
            </div>
          </div>
        </div>

      </div>

      <!-- Add To Cart Button -->
      <button id="AddToCartBtn" class="custom-atc-btn">
        <span>ADD TO CART</span>
        <svg width="25" height="10" viewBox="0 0 25 10" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M24.5 5L19.5 0V4.5H0V5.5H19.5V10L24.5 5Z" fill="white"/>
        </svg>
      </button>

    </div>
  </div>
</div>

<style>
  /* --- RESET & LAYOUT --- */
  * { box-sizing: border-box; }

  /* Overlay */
  .custom-modal-overlay {
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
    background: rgba(0,0,0,0.4); 
    display: none; 
    align-items: center; justify-content: center; 
    z-index: 9999;
  }

  /* Modal Box - Frame 1000009749 */
  .custom-modal-box {
    width: 311px;
    height: 447px;
    background: #FFFFFF;
    box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.2);
    position: relative;
    padding: 20px;
    display: flex;
    flex-direction: column;
  }

  .custom-modal-close {
    position: absolute;
    top: 15px; right: 15px;
    background: transparent; border: none; cursor: pointer;
    z-index: 10; padding: 5px;
  }

  .custom-modal-body {
    display: flex;
    flex-direction: column;
    height: 100%;
  }

  /* --- TOP SECTION --- */
  .custom-modal-top {
    display: flex;
    margin-bottom: 24px;
    margin-top: 16px; 
    gap: 8px;
  }

  .custom-modal-img-container {
    width: 120px;
    height: 140px;
    flex-shrink: 0;
  }
  #ModalImg {
    width: 100%; height: 100%; object-fit: cover;
    display: block;
  }

  .custom-modal-info {
    display: flex;
    flex-direction: column;
    padding-top: 13px;
  }

  #ModalTitle {
    font-family: 'Jost', sans-serif;
    font-weight: 300;
    font-size: 16px;
    line-height: 120%;
    color: #000000;
    margin: 0 0 5px 0;
  }

  #ModalPrice {
    font-family: 'Lustria', serif;
    font-weight: 400;
    font-size: 16px;
    line-height: 120%;
    color: #000000;
    margin: 0 0 12px 0;
  }

  .custom-modal-desc {
    font-family: 'Jost', sans-serif;
    font-weight: 300;
    font-size: 12px;
    line-height: 110%; 
    letter-spacing: -0.01em;
    color: #000000;
    width: 136px; 
    height: 52px;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 4;
    -webkit-box-orient: vertical;
  }

  /* --- VARIANTS SECTION --- */
  .custom-modal-variants {
    display: flex;
    flex-direction: column;
    gap: 15px;
  }

  .variant-group {
    width: 100%;
  }

  .variant-label {
    font-family: 'Jost', sans-serif;
    font-weight: 400;
    font-size: 14px;
    line-height: 130%;
    color: #000000;
    display: block;
    margin-bottom: 6px;
  }

  /* --- COMPONENT 211: COLOR --- */
  .custom-color-box {
    width: 271px;
    height: 40px;
    border: 0.5px solid #000000;
    display: flex;
    overflow: hidden;
  }

  .color-option {
    flex: 1;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    background: #FFFFFF;
    transition: background 0.3s ease, color 0.3s ease;
    border-right: 0.5px solid #000;
    position: relative;
    
    /* Typography */
    font-family: 'Jost', sans-serif;
    font-weight: 400;
    font-size: 18px;
    line-height: 100%;
    letter-spacing: -0.02em;
    color: #000000;
    text-transform: capitalize;
  }
  
  .color-option:last-child {
    border-right: none;
  }

  /* The small color indicator bar */
  .color-bar {
    position: absolute;
    left: 0;
    top: 0;
    height: 100%;
    /* Width and color set via JS based on variant */
    z-index: 1;
  }

  /* Active State (Selected) */
  .color-option.active {
    background: #000000;
    color: #FFFFFF;
  }

  /* --- COMPONENT 213: SIZE --- */
  .custom-dropdown-container {
    width: 271px;
    position: relative;
    z-index: 100;
  }

  .custom-dropdown-trigger {
    width: 271px;
    height: 40px;
    border: 0.5px solid #000000;
    background: #FFFFFF;
    display: flex;
    align-items: center;
    cursor: pointer;
  }

  #SelectedSizeText {
    flex-grow: 1;
    padding-left: 13px;
    font-family: 'Jost', sans-serif;
    font-weight: 400;
    font-size: 16px;
    line-height: 100%;
    letter-spacing: -0.02em;
    color: #000000;
    text-transform: capitalize;
  }

  .trigger-divider {
    width: 0.5px;
    height: 100%;
    background: #000000;
  }

  .trigger-arrow-box {
    width: 40px;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .custom-dropdown-options {
    display: none;
    position: absolute;
    top: 39px;
    left: 0;
    width: 271px;
    max-height: 182px;
    overflow-y: auto;
    background: #FFFFFF;
    border: 1px solid #000000;
    border-top: none;
    z-index: 200;
  }

  .custom-dropdown-options.show {
    display: block;
  }

  .custom-dropdown-options::-webkit-scrollbar {
    width: 4px;
  }
  .custom-dropdown-options::-webkit-scrollbar-thumb {
    background: #000;
  }

  .dropdown-item {
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    background: #FFFFFF;
    transition: all 0.2s ease;
    font-family: 'Jost', sans-serif;
    font-weight: 400;
    font-size: 16px;
    line-height: 100%;
    letter-spacing: -0.02em;
    text-transform: uppercase;
    color: #000000;
  }

  .dropdown-item:hover, 
  .dropdown-item.selected {
    background: #000000;
    color: #FFFFFF;
  }

  /* --- ADD TO CART BUTTON --- */
  .custom-atc-btn {
    width: 271px;
    height: 45px;
    background: #000000;
    color: #FFFFFF;
    border: none;
    margin-top: auto;
    margin-bottom: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    cursor: pointer;
    transition: opacity 0.2s;
  }
  
  .custom-atc-btn span {
    font-family: 'Jost', sans-serif;
    font-weight: 400;
    font-size: 16px;
    letter-spacing: 0.05em; 
  }

  .custom-atc-btn:hover {
    opacity: 0.9;
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const modal = document.getElementById('ProductModal');
  const modalImg = document.getElementById('ModalImg');
  const modalTitle = document.getElementById('ModalTitle');
  const modalPrice = document.getElementById('ModalPrice');
  const modalDesc = document.getElementById('ModalDesc');
  
  const colorGroup = document.getElementById('ColorGroup');
  const colorContainer = document.getElementById('ColorContainer');
  
  const sizeGroup = document.getElementById('SizeGroup');
  const sizeTrigger = document.getElementById('SizeTrigger');
  const sizeOptionsList = document.getElementById('SizeOptionsList');
  const selectedSizeText = document.getElementById('SelectedSizeText');
  
  const addToCartBtn = document.getElementById('AddToCartBtn');
  const closeBtn = document.querySelector('.custom-modal-close');

  let currentProduct = null;
  let selectedColor = null;
  let selectedSize = null;

  // --- MODAL OPEN LOGIC ---
  document.body.addEventListener('click', function(e) {
    const btn = e.target.closest('.js-open-popup');
    if (btn) {
      e.preventDefault();
      const productData = btn.getAttribute('data-product-json');
      if (productData) {
        try {
          currentProduct = JSON.parse(productData);
          initModal(currentProduct);
          modal.style.display = 'flex';
        } catch(err) {
          console.error('Error parsing product JSON', err);
        }
      }
    }
  });

  const closeModal = () => { modal.style.display = 'none'; };
  closeBtn.addEventListener('click', closeModal);
  modal.addEventListener('click', (e) => {
    if (e.target === modal) closeModal();
  });

  // --- INIT CONTENT ---
  function initModal(product) {
    selectedColor = null;
    selectedSize = null;
    selectedSizeText.innerText = "Choose your size";
    sizeOptionsList.classList.remove('show');

    modalTitle.innerText = product.title;
    const priceFormatted = (product.price / 100).toFixed(2).replace('.', ',') + '€';
    modalPrice.innerText = priceFormatted;
    
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = product.description;
    modalDesc.innerText = tempDiv.textContent.trim();
    
    if (product.featured_image) {
        modalImg.src = product.featured_image;
    } else if (product.images && product.images.length > 0) {
        modalImg.src = product.images[0];
    } else {
        modalImg.src = '';
    }

    colorGroup.style.display = 'none';
    sizeGroup.style.display = 'none';
    colorContainer.innerHTML = '';
    sizeOptionsList.innerHTML = '';

    const colorOptionName = product.options.find(opt => /color|colour/i.test(opt));
    const sizeOptionName = product.options.find(opt => /size/i.test(opt));
    
    const colorIdx = product.options.indexOf(colorOptionName);
    const sizeIdx = product.options.indexOf(sizeOptionName);

    // --- RENDER COLORS WITH INDICATOR BARS ---
    if (colorOptionName) {
      colorGroup.style.display = 'block';
      const colors = [...new Set(product.variants.map(v => v.options[colorIdx]))];
      
      colors.forEach((col, index) => {
        const colDiv = document.createElement('div');
        colDiv.className = 'color-option';
        
        // 1. Create the Color Bar
        const bar = document.createElement('div');
        bar.className = 'color-bar';
        const cName = col.toLowerCase();

        //  Colour logic for the bars
        if (cName === 'white') {
            // Rectangle 26065: Width 5.81px, White fill, Black border
            bar.style.width = '5.81px';
            bar.style.backgroundColor = '#FFFFFF';
            bar.style.border = '0.5px solid #000000';
        } else {
            // Rectangle 26067 (Black/Others): Width 4.84px, Black fill, Black border
            bar.style.width = '4.84px';
            bar.style.backgroundColor = '#000000';
            bar.style.border = '0.5px solid #000000';
        }

        colDiv.appendChild(bar);

        // 2. Create the Text
        const textSpan = document.createElement('span');
        textSpan.innerText = col;
        colDiv.appendChild(textSpan);

        colDiv.addEventListener('click', () => {
          document.querySelectorAll('.color-option').forEach(c => c.classList.remove('active'));
          colDiv.classList.add('active');
          selectedColor = col;
        });

        if (index === 0) {
            colDiv.classList.add('active');
            selectedColor = col;
        }

        colorContainer.appendChild(colDiv);
      });
    }

    // --- RENDER SIZES ---
    if (sizeOptionName) {
      sizeGroup.style.display = 'block';
      const sizes = [...new Set(product.variants.map(v => v.options[sizeIdx]))];
      
      sizes.forEach(size => {
        const item = document.createElement('div');
        item.className = 'dropdown-item';
        item.innerText = size;
        
        item.addEventListener('click', (e) => {
          e.stopPropagation();
          selectedSize = size;
          selectedSizeText.innerText = size;
          document.querySelectorAll('.dropdown-item').forEach(i => i.classList.remove('selected'));
          item.classList.add('selected');
          sizeOptionsList.classList.remove('show');
        });

        sizeOptionsList.appendChild(item);
      });
    }
  }

  // --- INTERACTIONS ---
  sizeTrigger.addEventListener('click', (e) => {
    e.stopPropagation();
    sizeOptionsList.classList.toggle('show');
  });

  document.addEventListener('click', (e) => {
    if (!sizeTrigger.contains(e.target)) {
      sizeOptionsList.classList.remove('show');
    }
  });

  // --- ADD TO CART ---
  addToCartBtn.addEventListener('click', () => {
    if (!currentProduct) return;

    if (sizeGroup.style.display !== 'none' && !selectedSize) {
      alert('Please choose a size.');
      return;
    }
    if (colorGroup.style.display !== 'none' && !selectedColor) {
      alert('Please choose a color.');
      return;
    }

    const variant = currentProduct.variants.find(v => {
      const matchColor = selectedColor ? v.options.includes(selectedColor) : true;
      const matchSize = selectedSize ? v.options.includes(selectedSize) : true;
      return matchColor && matchSize;
    });

    if (!variant) {
      alert('This combination is unavailable.');
      return;
    }

    const itemsToAdd = [{ id: variant.id, quantity: 1 }];

    const isBlack = selectedColor && selectedColor.toLowerCase() === 'black';
    const isMedium = selectedSize && (selectedSize.toLowerCase() === 'medium' || selectedSize === 'm');

    if (isBlack && isMedium) {
       itemsToAdd.push({ id: 51672829329690, quantity: 1 });
    }

    fetch(window.Shopify.routes.root + 'cart/add.js', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ items: itemsToAdd })
    })
    .then(response => response.json())
    .then(data => {
      window.location.href = '/cart';
    })
    .catch((error) => {
      console.error('Error:', error);
      alert('Failed to add to cart.');
    });
  });
});
</script>
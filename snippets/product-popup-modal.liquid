<!-- Load Fonts -->
<style>
  @import url('https://fonts.googleapis.com/css2?family=Jost:wght@300;400;500&family=Lustria&display=swap');
</style>

<div id="ProductModal" class="custom-modal-overlay">
  <div class="custom-modal-box">
    <!-- Close Button -->
    <button class="custom-modal-close">&times;</button>

    <div class="custom-modal-body">
      <!-- Top Section: Image + Info -->
      <div class="custom-modal-top">
        <div class="custom-modal-img-container">
          <img id="ModalImg" src="" alt="">
        </div>
        <div class="custom-modal-info">
          <h3 id="ModalTitle">Product Title</h3>
          <p id="ModalPrice">0,00€</p>
          <div id="ModalDesc" class="custom-modal-desc">
            Description goes here...
          </div>
        </div>
      </div>
      
      <!-- Variants Section -->
      <div class="custom-modal-variants">
        
        <!-- Color Selector (Segmented Box) -->
        <div class="variant-group" id="ColorGroup" style="display:none;">
          <label class="variant-label">Color</label>
          <div id="ColorContainer" class="custom-color-box">
            <!-- Colors injected via JS -->
          </div>
        </div>
        
        <!-- Size Selector (Custom Dropdown) -->
<div class="variant-group" id="SizeGroup" style="display:none;">
  <label class="variant-label">Size</label>
  
  <div class="custom-dropdown-container" id="CustomSizeDropdown">
    <!-- The Main Display Box (Trigger) -->
    <div class="custom-dropdown-trigger" id="SizeTrigger">
      <span id="SelectedSizeText">Choose your size</span>
      <div class="trigger-arrow-box">
        <svg width="12" height="7" viewBox="0 0 12 7" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M1 1L6 6L11 1" stroke="black" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
    </div>

    <!-- The Hidden List (Options) -->
    <div class="custom-dropdown-options" id="SizeOptionsList">
      <!-- Options will be injected here by JS -->
    </div>
  </div>
</div>

      </div>

      <!-- Add To Cart -->
      <button id="AddToCartBtn" class="custom-atc-btn">
        <span>ADD TO CART</span>
        <svg width="25" height="10" viewBox="0 0 25 10" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M24.5 5L19.5 0V4.5H0V5.5H19.5V10L24.5 5Z" fill="white"/>
        </svg>
      </button>

    </div>
  </div>
</div>

<style>
  /* Modal Overlay */
  .custom-modal-overlay {
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
    background: rgba(0,0,0,0.4); 
    display: none; 
    align-items: center; justify-content: center; 
    z-index: 9999;
  }

  /* Modal Box (Frame 1000009755) */
  .custom-modal-box {
    width: 311px;
    height: 447px;
    background: #FFFFFF;
    box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.2);
    position: relative;
    box-sizing: border-box;
    padding: 20px; /* Inferred from layout */
  }

  /* Close Button */
  .custom-modal-close {
    position: absolute;
    top: 10px; right: 10px;
    background: transparent; border: none;
    font-size: 24px; cursor: pointer; color: #000;
    line-height: 1;
    z-index: 10;
  }

  /* Layout Structure */
  .custom-modal-body {
    display: flex;
    flex-direction: column;
    height: 100%;
  }

  .custom-modal-top {
    display: flex;
    gap: 15px; /* Distance between image and text */
    margin-bottom: 20px;
    margin-top: 15px;
  }

  /* Image (image 846) */
  .custom-modal-img-container {
    width: 120px;
    height: 140px;
    flex-shrink: 0;
  }
  #ModalImg {
    width: 100%; height: 100%; object-fit: cover;
  }

  /* Typography */
  .custom-modal-info {
    display: flex;
    flex-direction: column;
  }

  /* Title */
  #ModalTitle {
    font-family: 'Jost', sans-serif;
    font-weight: 300; /* Light */
    font-size: 16px;
    line-height: 120%;
    margin: 13px 0 5px 0; /* Align with top 49px */
    color: #000;
  }

  /* Price */
  #ModalPrice {
    font-family: 'Lustria', serif;
    font-weight: 400;
    font-size: 16px;
    line-height: 120%;
    margin: 0 0 10px 0;
    color: #000;
  }

  /* Description */
  .custom-modal-desc {
    font-family: 'Jost', sans-serif;
    font-weight: 300; /* Light */
    font-size: 14px;
    line-height: 110%;
    letter-spacing: -0.01em;
    color: #000;
    width: 136px;
    height: 60px;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* Labels */
  .variant-label {
    font-family: 'Jost', sans-serif;
    font-weight: 400;
    font-size: 14px;
    line-height: 130%; /* 18.2px */
    color: #000;
    display: block;
    margin-bottom: 5px;
  }

  .variant-group {
    margin-bottom: 15px;
  }
  

  /* COLOR COMPONENT (Component 211) */
  .custom-color-box {
    width: 271px;
    height: 40px;
    border: 0.5px solid #000000;
    display: flex;
    align-items: center;
  }
  
  .color-option {
    flex: 1;
    text-align: center;
    font-family: 'Jost', sans-serif;
    font-weight: 400;
    font-size: 18px;
    line-height: 100%;
    letter-spacing: -0.02em;
    text-transform: capitalize; /* Title case */
    cursor: pointer;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative; 
    transition: background 0.2s, color 0.2s;
  }

  
  .color-option.active {
    background: #000;
    color: #fff;
  }

  /* Vertical Divider (Line 25) */
  .color-divider {
    width: 0.5px;
    height: 40px;
    background: #000;
  }
/* 1. SIZE DIVIDER  */
.size-divider {
  position: absolute;
  top: 0;
  bottom: 0;
  right: 40px; /* Positioned to the left of the arrow */
  width: 0.5px; 
  background: #000;
  z-index: 1;
  pointer-events: none;
}

/* 2. COLOR OPTION LAYOUT  */
.color-option {
  flex: 1;
  display: flex; /* Flex to align Bar and Text */
  align-items: center;
  justify-content: center;
  gap: 10px; /* Space between bar and text */
  position: relative;
  height: 100%;
  cursor: pointer;
  transition: background 0.2s, color 0.2s;
  /* Font styles remain same */
  font-family: 'Jost', sans-serif;
  font-weight: 400;
  font-size: 18px;
  line-height: 100%;
  letter-spacing: -0.02em;
  text-transform: capitalize; 
}
.color-bar {
  position: absolute; /* Takes the bar out of the flow */
  left: 0;            /* Pins it strictly to the left edge */
  top: 0;
  width: 6px; /* Approx 5.81px from Figma */
  height: 100%; /* Full height (approx 40px) */
  /* Default styling, colors injected via JS */
  flex-shrink: 0;
  z-index: 1;
}


/* Active State for Color text */
.color-option.active {
  background: #000;
  color: #fff;
}

  

  #SelectedSizeText {
    font-family: 'Jost', sans-serif;
    font-weight: 400;
    font-size: 18px;
    line-height: 100%;
    letter-spacing: -0.02em;
    text-transform: capitalize;
    color: #000;
  }

 /* --- CUSTOM SIZE DROPDOWN STYLES --- */

/* Main Container */
.custom-dropdown-container {
  width: 271px;
  position: relative; /* Essential for positioning the list below */
  font-family: 'Jost', sans-serif;
  user-select: none;
  z-index: 100; /* Ensure it floats above other content */
}

/* The Trigger (Top Box) */
.custom-dropdown-trigger {
  width: 100%;
  height: 40px; 
  border: 0.5px solid #000;
  background: #fff;
  display: flex;
  align-items: center;
  cursor: pointer;
  box-sizing: border-box;
}

/* The Text Area inside Trigger */
#SelectedSizeText {
  flex: 1; /* Takes up remaining space */
  padding-left: 15px; /* Spacing from left */
  font-weight: 400;
  font-size: 18px;
  text-transform: capitalize;
  color: #000;
  /* Centering text vertically */
  display: flex; 
  align-items: center;

  /* FIGMA TYPOGRAPHY SETTINGS */
  font-family: 'Jost', sans-serif;
  font-weight: 400;
  font-size: 16px;         /* Updated to 16px */
  line-height: 100%;       /* Added from Figma */
  letter-spacing: -0.02em; /* Added from Figma (-2%) */
  color: #000;
}

/* The Arrow Box (Right side) */
.trigger-arrow-box {
  width: 40px; /* Square box for arrow */
  height: 100%;
  border-left: 0.5px solid #000; /* The divider line */
  display: flex;
  align-items: center;
  justify-content: center;
}

/* The Dropdown List (Initially Hidden) */
.custom-dropdown-options {
  display: none; /* Hidden by default */
  position: absolute;
  top: 100%; /* Directly below the trigger */
  left: 0;
  width: 271px; /* Matches trigger width */
  max-height: 150px; /* Limits height to allow scrolling */
  overflow-y: auto; /* Enables Scroll (Pic 4) */
  background: #fff;
  border: 0.5px solid #000;
  border-top: none; /* Merges with the box above */
  box-sizing: border-box;
  z-index: 200;
}

/* Show the list when active */
.custom-dropdown-options.show {
  display: block;
}

/* Individual Option Items */
.dropdown-item {
  height: 36px; /* Figma Component 212 height */
  display: flex;
  align-items: center;
  justify-content: center; /* Center text */
  font-size: 16px;
  color: #000;
  cursor: pointer;
  transition: background 0.2s, color 0.2s;

  /* FIGMA TYPOGRAPHY SETTINGS */
  font-family: 'Jost', sans-serif;
  font-weight: 400;
  font-size: 16px;         
  line-height: 100%;       
  letter-spacing: -0.02em; 
  text-transform: uppercase; /* Ensures it looks like eg "XS" */
  color: #000;             /* Default Black Text */

}

/* Hover Effect */
.dropdown-item:hover, .dropdown-item.selected {
  background: #000000;     /* Figma: rgba(0,0,0,1) */
  color: #FFFFFF;          /* Figma: rgba(255,255,255,1) */
}

/* Selected State */
.dropdown-item.selected {
  background: #000;
  color: #fff;
}

/* Custom Scrollbar Styling (Optional, makes it look cleaner) */
.custom-dropdown-options::-webkit-scrollbar {
  width: 4px;
}
.custom-dropdown-options::-webkit-scrollbar-thumb {
  background: #ccc; 
  border-radius: 2px;
}

  /* ADD TO CART BUTTON (Group 1000007810) */
  .custom-atc-btn {
    width: 271px;
    height: 45px;
    background: #000000;
    color: #FFFFFF;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px; /* Adjust spacing between text and arrow */
    cursor: pointer;
    margin-top: auto; /* Push to bottom */
    margin-bottom: 10px;
    transition: opacity 0.2s;
  }
  
  .custom-atc-btn span {
    font-family: 'Jost', sans-serif;
    font-weight: 400;
    font-size: 16px;
    text-transform: uppercase;
    text-align: center;
  }

  .custom-atc-btn:hover {
    opacity: 0.9;
  }
</style>
<script>
document.addEventListener('DOMContentLoaded', function() {
  // --- ELEMENTS ---
  const modal = document.getElementById('ProductModal');
  const modalImg = document.getElementById('ModalImg');
  const modalTitle = document.getElementById('ModalTitle');
  const modalPrice = document.getElementById('ModalPrice');
  const modalDesc = document.getElementById('ModalDesc');
  
  const colorGroup = document.getElementById('ColorGroup');
  const colorContainer = document.getElementById('ColorContainer');
  
  // -- NEW SIZE ELEMENTS --
  const sizeGroup = document.getElementById('SizeGroup');
  const sizeTrigger = document.getElementById('SizeTrigger');
  const sizeOptionsList = document.getElementById('SizeOptionsList');
  const selectedSizeText = document.getElementById('SelectedSizeText');
  
  const addToCartBtn = document.getElementById('AddToCartBtn');

  // --- STATE ---
  let currentProduct = null;
  let selectedColor = null;
  let selectedSize = null;

  // 1. DROPDOWN TOGGLE LOGIC
  // Click on the box to toggle list
  sizeTrigger.addEventListener('click', function(e) {
    e.stopPropagation(); // Prevent closing immediately
    sizeOptionsList.classList.toggle('show');
  });

  // Close dropdown if clicking anywhere else on screen
  document.addEventListener('click', function(e) {
    if (!sizeTrigger.contains(e.target)) {
      sizeOptionsList.classList.remove('show');
    }
  });

  // 1. OPEN MODAL LOGIC
  document.body.addEventListener('click', function(e) {
    const btn = e.target.closest('.js-open-popup');
    if (btn) {
      e.preventDefault();
      try {
        const jsonStr = btn.getAttribute('data-product-json');
        currentProduct = JSON.parse(jsonStr);
        
        // Setup data
        openModal(currentProduct);
        
        // Show Modal
        modal.style.display = 'flex';
      } catch(err) {
        console.error('Error parsing product JSON', err);
      }
    }
  });

  // 2. CLOSE MODAL LOGIC
  document.querySelector('.custom-modal-close').addEventListener('click', () => {
    modal.style.display = 'none';
  });
  modal.addEventListener('click', (e) => {
    if (e.target === modal) modal.style.display = 'none';
  });

  // 3. MAIN FUNCTION TO SETUP MODAL
  function openModal(product) {
    // Reset State
    selectedColor = null;
    selectedSize = null;
    selectedSizeText.innerText = "Choose your size";
    sizeOptionsList.classList.remove('show');
    
    // Fill Info
    modalImg.src = product.featured_image ? product.featured_image : '';
    modalTitle.innerText = product.title;
    modalPrice.innerText = (product.price / 100).toFixed(2).replace('.', ',') + '€';
    
    // Description
    const div = document.createElement('div');
    div.innerHTML = product.description;
    modalDesc.innerText = div.textContent;

    // Clear Options
    colorContainer.innerHTML = '';
    sizeOptionsList.innerHTML = '';
    
    colorGroup.style.display = 'none';
    sizeGroup.style.display = 'none';

    // Helper: Find option names
    const colorOpt = product.options.find(o => /colo(u)?r/i.test(o));
    const sizeOpt = product.options.find(o => /size/i.test(o));
    
    // --- RENDER COLORS ---
    if (colorOpt) {
      colorGroup.style.display = 'block';
      const colorIndex = product.options.indexOf(colorOpt);
      const values = [...new Set(product.variants.map(v => v.options[colorIndex]))];

      const colorMap = {
        'blue': '#0047AB', 'red': '#C8102E', 'grey': '#9E9E9E',  
        'gray': '#9E9E9E', 'black': '#000000', 'white': '#FFFFFF'
      };
      
      values.forEach((val, idx) => {
        // Container
        const optDiv = document.createElement('div');
        optDiv.className = 'color-option';
        
        // Bar
        const barDiv = document.createElement('div');
        barDiv.className = 'color-bar';
        const cName = val.toLowerCase();
        
        if (cName === 'white') {
            barDiv.style.backgroundColor = '#FFFFFF';
            barDiv.style.border = '0.5px solid #000000'; 
        } else {
            barDiv.style.backgroundColor = colorMap[cName] || cName;
        }

        // Text
        const textSpan = document.createElement('span');
        textSpan.innerText = val;

        optDiv.appendChild(barDiv);
        optDiv.appendChild(textSpan);
        
        // Auto-select first
        if (idx === 0) {
           optDiv.classList.add('active');
           selectedColor = val;
        }

        // Click Handler
        optDiv.onclick = () => {
          document.querySelectorAll('.color-option').forEach(el => el.classList.remove('active'));
          optDiv.classList.add('active');
          selectedColor = val;
        };

        colorContainer.appendChild(optDiv);
        
        // Divider
        if (idx < values.length - 1) {
          const divider = document.createElement('div');
          divider.className = 'color-divider';
          colorContainer.appendChild(divider);
        }
      });
    }

    // --- RENDER SIZES (NEW CUSTOM LOGIC) ---
    if (sizeOpt) {
      sizeGroup.style.display = 'block';
      const sizeIndex = product.options.indexOf(sizeOpt);
      const values = [...new Set(product.variants.map(v => v.options[sizeIndex]))];
      
      // Create Custom Div Options
      values.forEach(val => {
        const item = document.createElement('div');
        item.className = 'dropdown-item';
        item.innerText = val; // e.g., "S", "M", "L"
        
        // Handle Click on specific Size
        item.addEventListener('click', function() {
          // 1. Update State
          selectedSize = val;
          // 2. Update Display Text
          selectedSizeText.innerText = val;
          // 3. Highlight selected (optional)
          document.querySelectorAll('.dropdown-item').forEach(i => i.classList.remove('selected'));
          item.classList.add('selected');
          // 4. Close Dropdown
          sizeOptionsList.classList.remove('show');
        });

        sizeOptionsList.appendChild(item);
      });
    }
  }


  // 4. ADD TO CART LOGIC
  addToCartBtn.addEventListener('click', function() {
    // Validation
    if (sizeGroup.style.display !== 'none' && !selectedSize) {
      alert("Please select a size.");
      return;
    }

    // Find Variant
    const variant = currentProduct.variants.find(v => {
      let matchColor = !selectedColor || v.options.includes(selectedColor);
      let matchSize = !selectedSize || v.options.includes(selectedSize);
      return matchColor && matchSize;
    });

    if (!variant) {
      alert("This variant is unavailable.");
      return;
    }

    // Payload
    let itemsToAdd = [{ id: variant.id, quantity: 1 }];

    // Soft Winter Jacket Special Logic
    const isBlack = selectedColor && selectedColor.toLowerCase() === 'black';
    const isMedium = selectedSize && (selectedSize.toLowerCase() === 'medium' || selectedSize === 'M');

    if (isBlack && isMedium) {
      itemsToAdd.push({ id: 51672829329690, quantity: 1 });
    }

    // Add to Cart Fetch
    fetch(window.Shopify.routes.root + 'cart/add.js', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ items: itemsToAdd })
    })
    .then(response => response.json())
    .then(data => {
      window.location.href = '/cart';
    })
    .catch((error) => {
      console.error('Error:', error);
      alert('Failed to add to cart.');
    });
  });

});
</script>